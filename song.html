<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>播放歌曲</title>
    <link rel="stylesheet" href="./song.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_359189_uj5ndtu3ln4p9zfr.css">
</head>

<body>
    <div class="page">
        <section class="pointer">
            <img src="//i.loli.net/2017/08/30/59a67191cc8b1.png" alt="指针">
        </section>
        <section class="disk">
            <div class="circle">
                <img class= "cover" src="//i.loli.net/2017/08/31/59a78ce4b4c78.png" alt="封面图片">
                <i class="iconfont icon-play1"></i>
                <i class="iconfont icon-pause3"></i>
            </div>
            <div class="lyric">
                <h2>If You Feel My Love (Chaow Mix)</h2> 
                <div class="lines">
                </div>
            </div>
        </section>

        <section class="actions">
            <a href="#" class="a1">打 开</a>
            <a href="#" class="a2">下 载</a>
        </section>
    </div>


    <script src="./vendors/av-min.js"></script>
    <script src="./scripts/av.js"></script>
    <script src="./vendors/jquery.min.js"></script>

    <script>
        function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
    </script>
    <script>
        let id = getParameterByName('id');
        var query = new AV.Query('Song');
        query.get(id).then(function (song) {
          let {url, lyric} = song.attributes
          let video = document.createElement('video')
          video.src = url
          video.oncanplay = function(){
              video.play()
              $('.circle').addClass('playing')
          }
          /*$('.icon-pause3').on('click',function(){
              video.pause()
              $('.circle').removeClass('playing')
          })*/
          var array = []
          var parts = lyric.split('\n')
          parts.forEach(function(string,index){
            let xxx = string.split(']')
            xxx[0] = xxx[0].substring(1)
            let regex = /(\d+):([\d.]+)/
            let matches = xxx[0].match(regex)
            let minute = +matches[1]
            let seconds = +matches[2]
            array.push({
              time: minute*60+seconds,
              lyric: xxx[1]
            })
            setInterval(function(){
                let current = video.currentTime
                for(let i=0;i<array.length;i++){
                if(i === array.length - 1){
                }else if(array[i].time <= current && array[i+1].time > current){
                    console.log(array[i].lyric)
                    break;
                    }
                }
            },500)
        })
        var $lyric = $('.lyric')
            array.map(function(song){
                if(!song){return}
                var $p =$('<p/>')
                $p.attr('data-time',song.time).text(song.lyric)
                $p.appendTo($lyric.children('.lines'))
            })
    })
    </script>
</body>

</html>