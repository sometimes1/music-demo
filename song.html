<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>播放歌曲</title>
    <link rel="stylesheet" href="./song.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_359189_uj5ndtu3ln4p9zfr.css">
</head>

<body>
    <div class="page">
        <div class="background"></div>
        <section class="pointer">
            <img src="//i.loli.net/2017/08/30/59a67191cc8b1.png" alt="指针">
        </section>
        <section class="disk">
            <div class="circle">
                <i class="iconfont icon-play1"></i>
                <i class="iconfont icon-pause3"></i>
            </div>
            <div class="lyric">
                <div class="name"></div>
                <div class="song-lyric">
                    <div class="lines"></div>
                </div>
                
            </div>
        </section>

        <section class="actions">
            <a href="#" class="a1">打 开</a>
            <a href="#" class="a2">下 载</a>
        </section>
    
    </div>


    <script src="./vendors/av-min.js"></script>
    <script src="./scripts/av.js"></script>
    <script src="./vendors/jquery.min.js"></script>

    <script>
        function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
    </script>
    <script>
        let id = getParameterByName('id');
        var query = new AV.Query('Song');
        query.get(id).then(function (song) {
          let {url, lyric} = song.attributes
          var images = song.attributes.images
          var singer = song.attributes.singer
          var img = `<img class="cover" src="${images}" alt="封面图片">`
          $('.circle').append(img)
          $('.background').css('background-image',`url(${images})`)
          var h2 = `<h2>${singer}</h2>`
          $('.lyric > .name').append(h2)
          let audio = document.createElement('audio')
          audio.src = url
          $('body').append(audio)
          audio.oncanplay = function(){
            audio.play()
          $('.circle').addClass('playing')
          }
          audio.oncanplay()
          $('.icon-pause3').on('click',function(){
              audio.pause()
              $('.circle').removeClass('playing')
              $('.pointer').addClass('pause')
          })
          $('.icon-play1').on('click',function(){
              audio.play()
              $('.circle').addClass('playing')
              $('.pointer').removeClass('pause')
          })
          
          
          var array = []
          var parts = lyric.split('\n')
          parts.forEach(function(string,index){
            let xxx = string.split(']')
            xxx[0] = xxx[0].substring(1)
            let regex = /(\d+):([\d.]+)/
            let matches = xxx[0].match(regex)
            let minute = +matches[1]
            let seconds = +matches[2]
            array.push({
              time: minute*60+seconds,
              lyric: xxx[1]
            })
            setInterval(function(){
                let current = audio.currentTime
                for(let i=0;i<array.length;i++){
                if(i === array.length - 1){
                    
                }else if(array[i].time <= current && array[i+1].time > current){
                    console.log(array[i].lyric)
                    break;
                    }
                }
            },500)
        })
        var $lyric = $('.lyric > .song-lyric')
            array.map(function(song){
                if(!song){return}
                var $p =$('<p/>')
                $p.attr('data-time',song.time).text(song.lyric)
                $p.appendTo($lyric.children('.lines'))
            })
        
        /*var $lines = $('.lines > p')
        array.map(function(song){
            for(let i=0;i<$lines.length;i++){
            let currentLineTime = $lines.eq(i).attr('data-time');
            let nextLineTime = $lines.eq(i+1).attr('data-time');
            if($lines.eq(i+1).length !==0 && currentLineTime < song.time && nextLineTime > song.time){
                $lines.eq(i)
            }
            console.log($lines.eq(i))
            if($lines.eq(i)){
                $lines.eq(i).addClass('active').prev().removeClass('active')
                let top = $lines.eq(i).offset().top;
                console.log(top)
                let linesTop = $('.lines').offset().top;
                console.log(linesTop)
                let delta = Math.floor(top - linesTop - $('.song-lyric').height()/3);
                $('.lines').css('transform',`translateY(-${delta}px)`)
                }
            }
        })*/
        
    })
    </script>
</body>

</html>